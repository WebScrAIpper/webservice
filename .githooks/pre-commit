#!/bin/sh

echo "Running Spotless before commit..."

# Get a list of currently staged files
STAGED_FILES=$(git diff --name-only --cached)

# Run Spotless formatting (force synchronous execution)
./gradlew spotlessApply || { echo "Spotless failed! Aborting commit."; exit 1; }

# Get a list of modified files after Spotless ran
MODIFIED_FILES=$(git diff --name-only)

# Find the intersection: files that were both staged and modified
FILES_TO_STAGE=$(comm -12 <(echo "$STAGED_FILES" | sort) <(echo "$MODIFIED_FILES" | sort))

# Stage only those files
if [ -n "$FILES_TO_STAGE" ]; then
    echo "$FILES_TO_STAGE" | xargs git add
    echo "Spotless formatting applied and staged only for originally staged files."
else
    echo "No formatting changes detected."
fi

echo "Pre-commit hook completed."
exit 0